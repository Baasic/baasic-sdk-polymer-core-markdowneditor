<link rel="import" href="../polymer/polymer.html" />
<link rel="import" href="../core-overlay/core-overlay.html" />
<link rel="import" href="baasic-markdownpreview.html" />

<!--
Provides a markdown editor. (ghost inspired)
This component use Codemirror as editor and marked.js for parse markdown.
Example:

    <baasic-markdowneditor id="editor">
    # H1

    Lipsum ...
    </baasic-markdowneditor>

@element baasic-markdowneditor
@homepage http://nchaulet.github.io/markdown-editor/
-->
<polymer-element name="baasic-markdowneditor" attributes="value">
    <template>
        <link rel="stylesheet" href="../codemirror/lib/codemirror.css">
        <link rel="stylesheet" type="text/css" href="baasic-markdowneditor.css" />
        <div id="container" layout horizontal>
            <div class="block">
                <h2 class="info">Markdown</h2>
                <div id="editor"></div>
            </div>
            <!-- preview pane is removed; turn on if you need instant markdown preview.
                <div class="block">
                <h2 class="info">Preview</h2>
                <baasic-markdownpreview id="preview" value="{{ value }}"/>
            </div> -->
        </div>
    </template>

    <script src="../codemirror/lib/codemirror.js"></script>
    <script src="../codemirror/mode/markdown/markdown.js"></script>
    <script>
        Polymer('baasic-markdowneditor', {
            observe: {
                'model.value': 'modelValueChanged'
            },
            /**
            * This property return current markdown value
            *
            * @attribute value
            * @type string
            * @default ""
            */
            value: '',
            ready: function () {
                var markdownElement = this.shadowRoot.getElementById('editor');

                var editor = CodeMirror(markdownElement, {
                    mode: "markdown",
                    lineNumbers: false
                });

                var _this = this;

                editor.on('changes', function () {
                    _this.model.setValue(editor.getValue());
                });

                this.modelValueChanged = function (oldValue, newValue) {
                    if (editor.getValue() != newValue) {
                        editor.setValue(newValue);
                    }

                    _this.value = newValue;
                };

                // INIT
                this.model = new MarkdownEditorModel(this.innerHTML);
                this.editor = editor;
            },
            refresh: function () {
                var editor = this.editor;
                setTimeout(function () { editor.refresh(); }, 100);
            },
            valueChanged: function (oldValue, newValue) {
                this.model.setValue(newValue);
            }
        });

        var MarkdownEditorModel = function (value) {
            this.value = value;
        };

        MarkdownEditorModel.prototype.setValue = function (value) {
            if (value != this.value) {
                this.value = value;
            }
        };
    </script>
</polymer-element>